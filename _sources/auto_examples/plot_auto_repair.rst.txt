

.. _sphx_glr_auto_examples_plot_auto_repair.py:


===========================
Automatically repair epochs
===========================

This example demonstrates how to use :mod:`autoreject` to automatically
repair epochs.


.. code-block:: python


    # Author: Mainak Jas <mainak.jas@telecom-paristech.fr>
    # License: BSD (3-clause)







Let us first define the parameters. `n_interpolates` are the :math:`\rho`
values that we would like :mod:`autoreject` to try and `consensus_percs`
are the :math:`\kappa` values that :mod:`autoreject` will try.

Epochs with more than :math:`\kappa * N` sensors (:math:`N` total sensors)
bad are dropped. For the rest of the epochs, the worst :math:`\rho`
bad sensors (as determined by channel-level thresholds) are interpolated.
The exact values of these parameters are not preselected but learned from
the data. If the number of bad sensors for a particular trial is less than
:math:`\rho`, all the bad sensors are interpolated.


.. code-block:: python

    import numpy as np

    n_interpolates = np.array([1, 4, 32])
    consensus_percs = np.linspace(0, 1.0, 11)







For the purposes of this example, we shall use the MNE sample dataset.
Therefore, let us make some MNE related imports.


.. code-block:: python


    import mne  # noqa
    from mne.utils import check_random_state  # noqa
    from mne.datasets import sample  # noqa







Now, we can import the class required for rejecting and repairing bad
epochs. :func:`autoreject.compute_thresholds` is a callable which must be
provided to the :class:`autoreject.LocalAutoRejectCV` class for computing
the channel-level thresholds.


.. code-block:: python


    from autoreject import (LocalAutoRejectCV, compute_thresholds,
                            set_matplotlib_defaults)  # noqa







Let us now read in the raw `fif` file for MNE sample dataset.


.. code-block:: python


    check_random_state(42)

    data_path = sample.data_path()
    raw_fname = data_path + '/MEG/sample/sample_audvis_filt-0-40_raw.fif'
    raw = mne.io.read_raw_fif(raw_fname, preload=True)





.. rst-class:: sphx-glr-script-out

 Out::

      Opening raw data file /home/mainak/Desktop/projects/github_repos/mne-python/examples/MNE-sample-data/MEG/sample/sample_audvis_filt-0-40_raw.fif...
        Read a total of 4 projection items:
            PCA-v1 (1 x 102)  idle
            PCA-v2 (1 x 102)  idle
            PCA-v3 (1 x 102)  idle
            Average EEG reference (1 x 60)  idle
        Range : 6450 ... 48149 =     42.956 ...   320.665 secs
    Ready.
    Current compensation grade : 0
    Reading 0 ... 41699  =      0.000 ...   277.709 secs...


We can then read in the events


.. code-block:: python


    event_fname = data_path + ('/MEG/sample/sample_audvis_filt-0-40_raw-'
                               'eve.fif')
    event_id = {'Auditory/Left': 1, 'Auditory/Right': 2}
    tmin, tmax = -0.2, 0.5

    events = mne.read_events(event_fname)







And pick MEG channels for repairing. Currently, :mod:`autoreject` can repair
only one channel type at a time.


.. code-block:: python


    raw.info['bads'] = []
    picks = mne.pick_types(raw.info, meg='grad', eeg=False, stim=False, eog=False,
                           include=[], exclude=[])







Now, we can create epochs. The ``reject`` params will be set to ``None``
because we do not want epochs to be dropped when instantiating
:class:`mne.Epochs`.


.. code-block:: python

    raw.info['projs'] = list()  # remove proj, don't proj while interpolating
    epochs = mne.Epochs(raw, events, event_id, tmin, tmax,
                        baseline=(None, 0), reject=None,
                        verbose=False, detrend=0, preload=True)







First, we set up the function to compute the sensor-level thresholds.


.. code-block:: python


    from functools import partial  # noqa
    thresh_func = partial(compute_thresholds, picks=picks, method='random_search',
                          random_state=42)







:class:`autoreject.LocalAutoRejectCV` internally does cross-validation to
determine the optimal values :math:`\rho^{*}` and :math:`\kappa^{*}`


.. code-block:: python



    epochs.ch_names
    ar = LocalAutoRejectCV(n_interpolates, consensus_percs, picks=picks,
                           thresh_func=thresh_func)
    epochs_clean = ar.fit_transform(epochs['Auditory/Left'])

    evoked = epochs.average()
    evoked_clean = epochs_clean.average()






.. rst-class:: sphx-glr-script-out

 Out::

      [                                        ] 0.49020 | Creating augmented epochs       [                                        ] 0.98039 / Creating augmented epochs       [                                        ] 1.47059 - Creating augmented epochs       [                                        ] 1.96078 \ Creating augmented epochs       [                                        ] 2.45098 | Creating augmented epochs       [.                                       ] 2.94118 / Creating augmented epochs       [.                                       ] 3.43137 - Creating augmented epochs       [.                                       ] 3.92157 \ Creating augmented epochs       [.                                       ] 4.41176 | Creating augmented epochs       [.                                       ] 4.90196 / Creating augmented epochs       [..                                      ] 5.39216 - Creating augmented epochs       [..                                      ] 5.88235 \ Creating augmented epochs       [..                                      ] 6.37255 | Creating augmented epochs       [..                                      ] 6.86275 / Creating augmented epochs       [..                                      ] 7.35294 - Creating augmented epochs       [...                                     ] 7.84314 \ Creating augmented epochs       [...                                     ] 8.33333 | Creating augmented epochs       [...                                     ] 8.82353 / Creating augmented epochs       [...                                     ] 9.31373 - Creating augmented epochs       [...                                     ] 9.80392 \ Creating augmented epochs       [....                                    ] 10.29412 | Creating augmented epochs       [....                                    ] 10.78431 / Creating augmented epochs       [....                                    ] 11.27451 - Creating augmented epochs       [....                                    ] 11.76471 \ Creating augmented epochs       [....                                    ] 12.25490 | Creating augmented epochs       [.....                                   ] 12.74510 / Creating augmented epochs       [.....                                   ] 13.23529 - Creating augmented epochs       [.....                                   ] 13.72549 \ Creating augmented epochs       [.....                                   ] 14.21569 | Creating augmented epochs       [.....                                   ] 14.70588 / Creating augmented epochs       [......                                  ] 15.19608 - Creating augmented epochs       [......                                  ] 15.68627 \ Creating augmented epochs       [......                                  ] 16.17647 | Creating augmented epochs       [......                                  ] 16.66667 / Creating augmented epochs       [......                                  ] 17.15686 - Creating augmented epochs       [.......                                 ] 17.64706 \ Creating augmented epochs       [.......                                 ] 18.13725 | Creating augmented epochs       [.......                                 ] 18.62745 / Creating augmented epochs       [.......                                 ] 19.11765 - Creating augmented epochs       [.......                                 ] 19.60784 \ Creating augmented epochs       [........                                ] 20.09804 | Creating augmented epochs       [........                                ] 20.58824 / Creating augmented epochs       [........                                ] 21.07843 - Creating augmented epochs       [........                                ] 21.56863 \ Creating augmented epochs       [........                                ] 22.05882 | Creating augmented epochs       [.........                               ] 22.54902 / Creating augmented epochs       [.........                               ] 23.03922 - Creating augmented epochs       [.........                               ] 23.52941 \ Creating augmented epochs       [.........                               ] 24.01961 | Creating augmented epochs       [.........                               ] 24.50980 / Creating augmented epochs       [..........                              ] 25.00000 - Creating augmented epochs       [..........                              ] 25.49020 \ Creating augmented epochs       [..........                              ] 25.98039 | Creating augmented epochs       [..........                              ] 26.47059 / Creating augmented epochs       [..........                              ] 26.96078 - Creating augmented epochs       [..........                              ] 27.45098 \ Creating augmented epochs       [...........                             ] 27.94118 | Creating augmented epochs       [...........                             ] 28.43137 / Creating augmented epochs       [...........                             ] 28.92157 - Creating augmented epochs       [...........                             ] 29.41176 \ Creating augmented epochs       [...........                             ] 29.90196 | Creating augmented epochs       [............                            ] 30.39216 / Creating augmented epochs       [............                            ] 30.88235 - Creating augmented epochs       [............                            ] 31.37255 \ Creating augmented epochs       [............                            ] 31.86275 | Creating augmented epochs       [............                            ] 32.35294 / Creating augmented epochs       [.............                           ] 32.84314 - Creating augmented epochs       [.............                           ] 33.33333 \ Creating augmented epochs       [.............                           ] 33.82353 | Creating augmented epochs       [.............                           ] 34.31373 / Creating augmented epochs       [.............                           ] 34.80392 - Creating augmented epochs       [..............                          ] 35.29412 \ Creating augmented epochs       [..............                          ] 35.78431 | Creating augmented epochs       [..............                          ] 36.27451 / Creating augmented epochs       [..............                          ] 36.76471 - Creating augmented epochs       [..............                          ] 37.25490 \ Creating augmented epochs       [...............                         ] 37.74510 | Creating augmented epochs       [...............                         ] 38.23529 / Creating augmented epochs       [...............                         ] 38.72549 - Creating augmented epochs       [...............                         ] 39.21569 \ Creating augmented epochs       [...............                         ] 39.70588 | Creating augmented epochs       [................                        ] 40.19608 / Creating augmented epochs       [................                        ] 40.68627 - Creating augmented epochs       [................                        ] 41.17647 \ Creating augmented epochs       [................                        ] 41.66667 | Creating augmented epochs       [................                        ] 42.15686 / Creating augmented epochs       [.................                       ] 42.64706 - Creating augmented epochs       [.................                       ] 43.13725 \ Creating augmented epochs       [.................                       ] 43.62745 | Creating augmented epochs       [.................                       ] 44.11765 / Creating augmented epochs       [.................                       ] 44.60784 - Creating augmented epochs       [..................                      ] 45.09804 \ Creating augmented epochs       [..................                      ] 45.58824 | Creating augmented epochs       [..................                      ] 46.07843 / Creating augmented epochs       [..................                      ] 46.56863 - Creating augmented epochs       [..................                      ] 47.05882 \ Creating augmented epochs       [...................                     ] 47.54902 | Creating augmented epochs       [...................                     ] 48.03922 / Creating augmented epochs       [...................                     ] 48.52941 - Creating augmented epochs       [...................                     ] 49.01961 \ Creating augmented epochs       [...................                     ] 49.50980 | Creating augmented epochs       [....................                    ] 50.00000 / Creating augmented epochs       [....................                    ] 50.49020 - Creating augmented epochs       [....................                    ] 50.98039 \ Creating augmented epochs       [....................                    ] 51.47059 | Creating augmented epochs       [....................                    ] 51.96078 / Creating augmented epochs       [....................                    ] 52.45098 - Creating augmented epochs       [.....................                   ] 52.94118 \ Creating augmented epochs       [.....................                   ] 53.43137 | Creating augmented epochs       [.....................                   ] 53.92157 / Creating augmented epochs       [.....................                   ] 54.41176 - Creating augmented epochs       [.....................                   ] 54.90196 \ Creating augmented epochs       [......................                  ] 55.39216 | Creating augmented epochs       [......................                  ] 55.88235 / Creating augmented epochs       [......................                  ] 56.37255 - Creating augmented epochs       [......................                  ] 56.86275 \ Creating augmented epochs       [......................                  ] 57.35294 | Creating augmented epochs       [.......................                 ] 57.84314 / Creating augmented epochs       [.......................                 ] 58.33333 - Creating augmented epochs       [.......................                 ] 58.82353 \ Creating augmented epochs       [.......................                 ] 59.31373 | Creating augmented epochs       [.......................                 ] 59.80392 / Creating augmented epochs       [........................                ] 60.29412 - Creating augmented epochs       [........................                ] 60.78431 \ Creating augmented epochs       [........................                ] 61.27451 | Creating augmented epochs       [........................                ] 61.76471 / Creating augmented epochs       [........................                ] 62.25490 - Creating augmented epochs       [.........................               ] 62.74510 \ Creating augmented epochs       [.........................               ] 63.23529 | Creating augmented epochs       [.........................               ] 63.72549 / Creating augmented epochs       [.........................               ] 64.21569 - Creating augmented epochs       [.........................               ] 64.70588 \ Creating augmented epochs       [..........................              ] 65.19608 | Creating augmented epochs       [..........................              ] 65.68627 / Creating augmented epochs       [..........................              ] 66.17647 - Creating augmented epochs       [..........................              ] 66.66667 \ Creating augmented epochs       [..........................              ] 67.15686 | Creating augmented epochs       [...........................             ] 67.64706 / Creating augmented epochs       [...........................             ] 68.13725 - Creating augmented epochs       [...........................             ] 68.62745 \ Creating augmented epochs       [...........................             ] 69.11765 | Creating augmented epochs       [...........................             ] 69.60784 / Creating augmented epochs       [............................            ] 70.09804 - Creating augmented epochs       [............................            ] 70.58824 \ Creating augmented epochs       [............................            ] 71.07843 | Creating augmented epochs       [............................            ] 71.56863 / Creating augmented epochs       [............................            ] 72.05882 - Creating augmented epochs       [.............................           ] 72.54902 \ Creating augmented epochs       [.............................           ] 73.03922 | Creating augmented epochs       [.............................           ] 73.52941 / Creating augmented epochs       [.............................           ] 74.01961 - Creating augmented epochs       [.............................           ] 74.50980 \ Creating augmented epochs       [..............................          ] 75.00000 | Creating augmented epochs       [..............................          ] 75.49020 / Creating augmented epochs       [..............................          ] 75.98039 - Creating augmented epochs       [..............................          ] 76.47059 \ Creating augmented epochs       [..............................          ] 76.96078 | Creating augmented epochs       [..............................          ] 77.45098 / Creating augmented epochs       [...............................         ] 77.94118 - Creating augmented epochs       [...............................         ] 78.43137 \ Creating augmented epochs       [...............................         ] 78.92157 | Creating augmented epochs       [...............................         ] 79.41176 / Creating augmented epochs       [...............................         ] 79.90196 - Creating augmented epochs       [................................        ] 80.39216 \ Creating augmented epochs       [................................        ] 80.88235 | Creating augmented epochs       [................................        ] 81.37255 / Creating augmented epochs       [................................        ] 81.86275 - Creating augmented epochs       [................................        ] 82.35294 \ Creating augmented epochs       [.................................       ] 82.84314 | Creating augmented epochs       [.................................       ] 83.33333 / Creating augmented epochs       [.................................       ] 83.82353 - Creating augmented epochs       [.................................       ] 84.31373 \ Creating augmented epochs       [.................................       ] 84.80392 | Creating augmented epochs       [..................................      ] 85.29412 / Creating augmented epochs       [..................................      ] 85.78431 - Creating augmented epochs       [..................................      ] 86.27451 \ Creating augmented epochs       [..................................      ] 86.76471 | Creating augmented epochs       [..................................      ] 87.25490 / Creating augmented epochs       [...................................     ] 87.74510 - Creating augmented epochs       [...................................     ] 88.23529 \ Creating augmented epochs       [...................................     ] 88.72549 | Creating augmented epochs       [...................................     ] 89.21569 / Creating augmented epochs       [...................................     ] 89.70588 - Creating augmented epochs       [....................................    ] 90.19608 \ Creating augmented epochs       [....................................    ] 90.68627 | Creating augmented epochs       [....................................    ] 91.17647 / Creating augmented epochs       [....................................    ] 91.66667 - Creating augmented epochs       [....................................    ] 92.15686 \ Creating augmented epochs       [.....................................   ] 92.64706 | Creating augmented epochs       [.....................................   ] 93.13725 / Creating augmented epochs       [.....................................   ] 93.62745 - Creating augmented epochs       [.....................................   ] 94.11765 \ Creating augmented epochs       [.....................................   ] 94.60784 | Creating augmented epochs       [......................................  ] 95.09804 / Creating augmented epochs       [......................................  ] 95.58824 - Creating augmented epochs       [......................................  ] 96.07843 \ Creating augmented epochs       [......................................  ] 96.56863 | Creating augmented epochs       [......................................  ] 97.05882 / Creating augmented epochs       [....................................... ] 97.54902 - Creating augmented epochs       [....................................... ] 98.03922 \ Creating augmented epochs       [....................................... ] 98.52941 | Creating augmented epochs       [....................................... ] 99.01961 / Creating augmented epochs       [....................................... ] 99.50980 - Creating augmented epochs       [........................................] 100.00000 \ Creating augmented epochs   [Parallel(n_jobs=1)]: Done   1 out of   1 | elapsed:    0.3s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   2 out of   2 | elapsed:    0.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   3 out of   3 | elapsed:    0.8s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   4 out of   4 | elapsed:    1.1s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   5 out of   5 | elapsed:    1.3s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   6 out of   6 | elapsed:    1.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   7 out of   7 | elapsed:    1.9s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   8 out of   8 | elapsed:    2.2s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done   9 out of   9 | elapsed:    2.4s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  10 out of  10 | elapsed:    2.7s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  11 out of  11 | elapsed:    3.0s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  12 out of  12 | elapsed:    3.2s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  13 out of  13 | elapsed:    3.5s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  14 out of  14 | elapsed:    3.8s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  15 out of  15 | elapsed:    4.0s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  16 out of  16 | elapsed:    4.3s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  17 out of  17 | elapsed:    4.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  18 out of  18 | elapsed:    4.8s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  19 out of  19 | elapsed:    5.1s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  20 out of  20 | elapsed:    5.4s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  21 out of  21 | elapsed:    5.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  22 out of  22 | elapsed:    5.9s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  23 out of  23 | elapsed:    6.2s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  24 out of  24 | elapsed:    6.5s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  25 out of  25 | elapsed:    6.8s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  26 out of  26 | elapsed:    7.0s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  27 out of  27 | elapsed:    7.3s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  28 out of  28 | elapsed:    7.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  29 out of  29 | elapsed:    7.9s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  30 out of  30 | elapsed:    8.1s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  31 out of  31 | elapsed:    8.4s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  32 out of  32 | elapsed:    8.7s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  33 out of  33 | elapsed:    9.0s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  34 out of  34 | elapsed:    9.2s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  35 out of  35 | elapsed:    9.5s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  36 out of  36 | elapsed:    9.7s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  37 out of  37 | elapsed:   10.0s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  38 out of  38 | elapsed:   10.3s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  39 out of  39 | elapsed:   10.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  40 out of  40 | elapsed:   10.8s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  41 out of  41 | elapsed:   11.1s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  42 out of  42 | elapsed:   11.4s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  43 out of  43 | elapsed:   11.6s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  44 out of  44 | elapsed:   11.9s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  45 out of  45 | elapsed:   12.2s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  46 out of  46 | elapsed:   12.5s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  47 out of  47 | elapsed:   12.7s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  48 out of  48 | elapsed:   13.0s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  49 out of  49 | elapsed:   13.2s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done  50 out of  50 | elapsed:   13.5s remaining:    0.0s
    [Parallel(n_jobs=1)]: Done 204 out of 204 | elapsed:   55.0s finished
    [                                        ] 1.38889 | Repairing epochs       [.                                       ] 2.77778 / Repairing epochs       [.                                       ] 4.16667 - Repairing epochs       [..                                      ] 5.55556 \ Repairing epochs       [..                                      ] 6.94444 | Repairing epochs       [...                                     ] 8.33333 / Repairing epochs       [...                                     ] 9.72222 - Repairing epochs       [....                                    ] 11.11111 \ Repairing epochs       [.....                                   ] 12.50000 | Repairing epochs       [.....                                   ] 13.88889 / Repairing epochs       [......                                  ] 15.27778 - Repairing epochs       [......                                  ] 16.66667 \ Repairing epochs       [.......                                 ] 18.05556 | Repairing epochs       [.......                                 ] 19.44444 / Repairing epochs       [........                                ] 20.83333 - Repairing epochs       [........                                ] 22.22222 \ Repairing epochs       [.........                               ] 23.61111 | Repairing epochs       [..........                              ] 25.00000 / Repairing epochs       [..........                              ] 26.38889 - Repairing epochs       [...........                             ] 27.77778 \ Repairing epochs       [...........                             ] 29.16667 | Repairing epochs       [............                            ] 30.55556 / Repairing epochs       [............                            ] 31.94444 - Repairing epochs       [.............                           ] 33.33333 \ Repairing epochs       [.............                           ] 34.72222 | Repairing epochs       [..............                          ] 36.11111 / Repairing epochs       [...............                         ] 37.50000 - Repairing epochs       [...............                         ] 38.88889 \ Repairing epochs       [................                        ] 40.27778 | Repairing epochs       [................                        ] 41.66667 / Repairing epochs       [.................                       ] 43.05556 - Repairing epochs       [.................                       ] 44.44444 \ Repairing epochs       [..................                      ] 45.83333 | Repairing epochs       [..................                      ] 47.22222 / Repairing epochs       [...................                     ] 48.61111 - Repairing epochs       [....................                    ] 50.00000 \ Repairing epochs       [....................                    ] 51.38889 | Repairing epochs       [.....................                   ] 52.77778 / Repairing epochs       [.....................                   ] 54.16667 - Repairing epochs       [......................                  ] 55.55556 \ Repairing epochs       [......................                  ] 56.94444 | Repairing epochs       [.......................                 ] 58.33333 / Repairing epochs       [.......................                 ] 59.72222 - Repairing epochs       [........................                ] 61.11111 \ Repairing epochs       [.........................               ] 62.50000 | Repairing epochs       [.........................               ] 63.88889 / Repairing epochs       [..........................              ] 65.27778 - Repairing epochs       [..........................              ] 66.66667 \ Repairing epochs       [...........................             ] 68.05556 | Repairing epochs       [...........................             ] 69.44444 / Repairing epochs       [............................            ] 70.83333 - Repairing epochs       [............................            ] 72.22222 \ Repairing epochs       [.............................           ] 73.61111 | Repairing epochs       [..............................          ] 75.00000 / Repairing epochs       [..............................          ] 76.38889 - Repairing epochs       [...............................         ] 77.77778 \ Repairing epochs       [...............................         ] 79.16667 | Repairing epochs       [................................        ] 80.55556 / Repairing epochs       [................................        ] 81.94444 - Repairing epochs       [.................................       ] 83.33333 \ Repairing epochs       [.................................       ] 84.72222 | Repairing epochs       [..................................      ] 86.11111 / Repairing epochs       [...................................     ] 87.50000 - Repairing epochs       [...................................     ] 88.88889 \ Repairing epochs       [....................................    ] 90.27778 | Repairing epochs       [....................................    ] 91.66667 / Repairing epochs       [.....................................   ] 93.05556 - Repairing epochs       [.....................................   ] 94.44444 \ Repairing epochs       [......................................  ] 95.83333 | Repairing epochs       [......................................  ] 97.22222 / Repairing epochs       [....................................... ] 98.61111 - Repairing epochs       [........................................] 100.00000 \ Repairing epochs       [....                                    ] 10.00000 | Fold       [........                                ] 20.00000 / Fold       [............                            ] 30.00000 - Fold       [................                        ] 40.00000 \ Fold       [....................                    ] 50.00000 | Fold       [........................                ] 60.00000 / Fold       [............................            ] 70.00000 - Fold       [................................        ] 80.00000 \ Fold       [....................................    ] 90.00000 | Fold       [........................................] 100.00000 / Fold       [.............                           ] 33.33333 | n_interp       [                                        ] 1.38889 | Repairing epochs       [.                                       ] 2.77778 / Repairing epochs       [.                                       ] 4.16667 - Repairing epochs       [..                                      ] 5.55556 \ Repairing epochs       [..                                      ] 6.94444 | Repairing epochs       [...                                     ] 8.33333 / Repairing epochs       [...                                     ] 9.72222 - Repairing epochs       [....                                    ] 11.11111 \ Repairing epochs       [.....                                   ] 12.50000 | Repairing epochs       [.....                                   ] 13.88889 / Repairing epochs       [......                                  ] 15.27778 - Repairing epochs       [......                                  ] 16.66667 \ Repairing epochs       [.......                                 ] 18.05556 | Repairing epochs       [.......                                 ] 19.44444 / Repairing epochs       [........                                ] 20.83333 - Repairing epochs       [........                                ] 22.22222 \ Repairing epochs       [.........                               ] 23.61111 | Repairing epochs       [..........                              ] 25.00000 / Repairing epochs       [..........                              ] 26.38889 - Repairing epochs       [...........                             ] 27.77778 \ Repairing epochs       [...........                             ] 29.16667 | Repairing epochs       [............                            ] 30.55556 / Repairing epochs       [............                            ] 31.94444 - Repairing epochs       [.............                           ] 33.33333 \ Repairing epochs       [.............                           ] 34.72222 | Repairing epochs       [..............                          ] 36.11111 / Repairing epochs       [...............                         ] 37.50000 - Repairing epochs       [...............                         ] 38.88889 \ Repairing epochs       [................                        ] 40.27778 | Repairing epochs       [................                        ] 41.66667 / Repairing epochs       [.................                       ] 43.05556 - Repairing epochs       [.................                       ] 44.44444 \ Repairing epochs       [..................                      ] 45.83333 | Repairing epochs       [..................                      ] 47.22222 / Repairing epochs       [...................                     ] 48.61111 - Repairing epochs       [....................                    ] 50.00000 \ Repairing epochs       [....................                    ] 51.38889 | Repairing epochs       [.....................                   ] 52.77778 / Repairing epochs       [.....................                   ] 54.16667 - Repairing epochs       [......................                  ] 55.55556 \ Repairing epochs       [......................                  ] 56.94444 | Repairing epochs       [.......................                 ] 58.33333 / Repairing epochs       [.......................                 ] 59.72222 - Repairing epochs       [........................                ] 61.11111 \ Repairing epochs       [.........................               ] 62.50000 | Repairing epochs       [.........................               ] 63.88889 / Repairing epochs       [..........................              ] 65.27778 - Repairing epochs       [..........................              ] 66.66667 \ Repairing epochs       [...........................             ] 68.05556 | Repairing epochs       [...........................             ] 69.44444 / Repairing epochs       [............................            ] 70.83333 - Repairing epochs       [............................            ] 72.22222 \ Repairing epochs       [.............................           ] 73.61111 | Repairing epochs       [..............................          ] 75.00000 / Repairing epochs       [..............................          ] 76.38889 - Repairing epochs       [...............................         ] 77.77778 \ Repairing epochs       [...............................         ] 79.16667 | Repairing epochs       [................................        ] 80.55556 / Repairing epochs       [................................        ] 81.94444 - Repairing epochs       [.................................       ] 83.33333 \ Repairing epochs       [.................................       ] 84.72222 | Repairing epochs       [..................................      ] 86.11111 / Repairing epochs       [...................................     ] 87.50000 - Repairing epochs       [...................................     ] 88.88889 \ Repairing epochs       [....................................    ] 90.27778 | Repairing epochs       [....................................    ] 91.66667 / Repairing epochs       [.....................................   ] 93.05556 - Repairing epochs       [.....................................   ] 94.44444 \ Repairing epochs       [......................................  ] 95.83333 | Repairing epochs       [......................................  ] 97.22222 / Repairing epochs       [....................................... ] 98.61111 - Repairing epochs       [........................................] 100.00000 \ Repairing epochs       [....                                    ] 10.00000 | Fold       [........                                ] 20.00000 / Fold       [............                            ] 30.00000 - Fold       [................                        ] 40.00000 \ Fold       [....................                    ] 50.00000 | Fold       [........................                ] 60.00000 / Fold       [............................            ] 70.00000 - Fold       [................................        ] 80.00000 \ Fold       [....................................    ] 90.00000 | Fold       [........................................] 100.00000 / Fold       [..........................              ] 66.66667 / n_interp       [                                        ] 1.38889 | Repairing epochs       [.                                       ] 2.77778 / Repairing epochs       [.                                       ] 4.16667 - Repairing epochs       [..                                      ] 5.55556 \ Repairing epochs       [..                                      ] 6.94444 | Repairing epochs       [...                                     ] 8.33333 / Repairing epochs       [...                                     ] 9.72222 - Repairing epochs       [....                                    ] 11.11111 \ Repairing epochs       [.....                                   ] 12.50000 | Repairing epochs       [.....                                   ] 13.88889 / Repairing epochs       [......                                  ] 15.27778 - Repairing epochs       [......                                  ] 16.66667 \ Repairing epochs       [.......                                 ] 18.05556 | Repairing epochs       [.......                                 ] 19.44444 / Repairing epochs       [........                                ] 20.83333 - Repairing epochs       [........                                ] 22.22222 \ Repairing epochs       [.........                               ] 23.61111 | Repairing epochs       [..........                              ] 25.00000 / Repairing epochs       [..........                              ] 26.38889 - Repairing epochs       [...........                             ] 27.77778 \ Repairing epochs       [...........                             ] 29.16667 | Repairing epochs       [............                            ] 30.55556 / Repairing epochs       [............                            ] 31.94444 - Repairing epochs       [.............                           ] 33.33333 \ Repairing epochs       [.............                           ] 34.72222 | Repairing epochs       [..............                          ] 36.11111 / Repairing epochs       [...............                         ] 37.50000 - Repairing epochs       [...............                         ] 38.88889 \ Repairing epochs       [................                        ] 40.27778 | Repairing epochs       [................                        ] 41.66667 / Repairing epochs       [.................                       ] 43.05556 - Repairing epochs       [.................                       ] 44.44444 \ Repairing epochs       [..................                      ] 45.83333 | Repairing epochs       [..................                      ] 47.22222 / Repairing epochs       [...................                     ] 48.61111 - Repairing epochs       [....................                    ] 50.00000 \ Repairing epochs       [....................                    ] 51.38889 | Repairing epochs       [.....................                   ] 52.77778 / Repairing epochs       [.....................                   ] 54.16667 - Repairing epochs       [......................                  ] 55.55556 \ Repairing epochs       [......................                  ] 56.94444 | Repairing epochs       [.......................                 ] 58.33333 / Repairing epochs       [.......................                 ] 59.72222 - Repairing epochs       [........................                ] 61.11111 \ Repairing epochs       [.........................               ] 62.50000 | Repairing epochs       [.........................               ] 63.88889 / Repairing epochs       [..........................              ] 65.27778 - Repairing epochs       [..........................              ] 66.66667 \ Repairing epochs       [...........................             ] 68.05556 | Repairing epochs       [...........................             ] 69.44444 / Repairing epochs       [............................            ] 70.83333 - Repairing epochs       [............................            ] 72.22222 \ Repairing epochs       [.............................           ] 73.61111 | Repairing epochs       [..............................          ] 75.00000 / Repairing epochs       [..............................          ] 76.38889 - Repairing epochs       [...............................         ] 77.77778 \ Repairing epochs       [...............................         ] 79.16667 | Repairing epochs       [................................        ] 80.55556 / Repairing epochs       [................................        ] 81.94444 - Repairing epochs       [.................................       ] 83.33333 \ Repairing epochs       [.................................       ] 84.72222 | Repairing epochs       [..................................      ] 86.11111 / Repairing epochs       [...................................     ] 87.50000 - Repairing epochs       [...................................     ] 88.88889 \ Repairing epochs       [....................................    ] 90.27778 | Repairing epochs       [....................................    ] 91.66667 / Repairing epochs       [.....................................   ] 93.05556 - Repairing epochs       [.....................................   ] 94.44444 \ Repairing epochs       [......................................  ] 95.83333 | Repairing epochs       [......................................  ] 97.22222 / Repairing epochs       [....................................... ] 98.61111 - Repairing epochs       [........................................] 100.00000 \ Repairing epochs       [....                                    ] 10.00000 | Fold       [........                                ] 20.00000 / Fold       [............                            ] 30.00000 - Fold       [................                        ] 40.00000 \ Fold       [....................                    ] 50.00000 | Fold       [........................                ] 60.00000 / Fold       [............................            ] 70.00000 - Fold       [................................        ] 80.00000 \ Fold       [....................................    ] 90.00000 | Fold       [........................................] 100.00000 / Fold       [........................................] 100.00000 - n_interp   Estimated consensus_perc=0.20 and n_interpolate=32
    [                                        ] 1.38889 | Repairing epochs       [.                                       ] 2.77778 / Repairing epochs       [.                                       ] 4.16667 - Repairing epochs       [..                                      ] 5.55556 \ Repairing epochs       [..                                      ] 6.94444 | Repairing epochs       [...                                     ] 8.33333 / Repairing epochs       [...                                     ] 9.72222 - Repairing epochs       [....                                    ] 11.11111 \ Repairing epochs       [.....                                   ] 12.50000 | Repairing epochs       [.....                                   ] 13.88889 / Repairing epochs       [......                                  ] 15.27778 - Repairing epochs       [......                                  ] 16.66667 \ Repairing epochs       [.......                                 ] 18.05556 | Repairing epochs       [.......                                 ] 19.44444 / Repairing epochs       [........                                ] 20.83333 - Repairing epochs       [........                                ] 22.22222 \ Repairing epochs       [.........                               ] 23.61111 | Repairing epochs       [..........                              ] 25.00000 / Repairing epochs       [..........                              ] 26.38889 - Repairing epochs       [...........                             ] 27.77778 \ Repairing epochs       [...........                             ] 29.16667 | Repairing epochs       [............                            ] 30.55556 / Repairing epochs       [............                            ] 31.94444 - Repairing epochs       [.............                           ] 33.33333 \ Repairing epochs       [.............                           ] 34.72222 | Repairing epochs       [..............                          ] 36.11111 / Repairing epochs       [...............                         ] 37.50000 - Repairing epochs       [...............                         ] 38.88889 \ Repairing epochs       [................                        ] 40.27778 | Repairing epochs       [................                        ] 41.66667 / Repairing epochs       [.................                       ] 43.05556 - Repairing epochs       [.................                       ] 44.44444 \ Repairing epochs       [..................                      ] 45.83333 | Repairing epochs       [..................                      ] 47.22222 / Repairing epochs       [...................                     ] 48.61111 - Repairing epochs       [....................                    ] 50.00000 \ Repairing epochs       [....................                    ] 51.38889 | Repairing epochs       [.....................                   ] 52.77778 / Repairing epochs       [.....................                   ] 54.16667 - Repairing epochs       [......................                  ] 55.55556 \ Repairing epochs       [......................                  ] 56.94444 | Repairing epochs       [.......................                 ] 58.33333 / Repairing epochs       [.......................                 ] 59.72222 - Repairing epochs       [........................                ] 61.11111 \ Repairing epochs       [.........................               ] 62.50000 | Repairing epochs       [.........................               ] 63.88889 / Repairing epochs       [..........................              ] 65.27778 - Repairing epochs       [..........................              ] 66.66667 \ Repairing epochs       [...........................             ] 68.05556 | Repairing epochs       [...........................             ] 69.44444 / Repairing epochs       [............................            ] 70.83333 - Repairing epochs       [............................            ] 72.22222 \ Repairing epochs       [.............................           ] 73.61111 | Repairing epochs       [..............................          ] 75.00000 / Repairing epochs       [..............................          ] 76.38889 - Repairing epochs       [...............................         ] 77.77778 \ Repairing epochs       [...............................         ] 79.16667 | Repairing epochs       [................................        ] 80.55556 / Repairing epochs       [................................        ] 81.94444 - Repairing epochs       [.................................       ] 83.33333 \ Repairing epochs       [.................................       ] 84.72222 | Repairing epochs       [..................................      ] 86.11111 / Repairing epochs       [...................................     ] 87.50000 - Repairing epochs       [...................................     ] 88.88889 \ Repairing epochs       [....................................    ] 90.27778 | Repairing epochs       [....................................    ] 91.66667 / Repairing epochs       [.....................................   ] 93.05556 - Repairing epochs       [.....................................   ] 94.44444 \ Repairing epochs       [......................................  ] 95.83333 | Repairing epochs       [......................................  ] 97.22222 / Repairing epochs       [....................................... ] 98.61111 - Repairing epochs       [........................................] 100.00000 \ Repairing epochs


Now, we will manually mark the bad channels just for plotting.


.. code-block:: python


    evoked.info['bads'] = ['MEG 2443']
    evoked_clean.info['bads'] = ['MEG 2443']







Let us plot the results.


.. code-block:: python


    import matplotlib.pyplot as plt  # noqa
    set_matplotlib_defaults(plt)

    fig, axes = plt.subplots(2, 1, figsize=(6, 6))

    for ax in axes:
        ax.tick_params(axis='x', which='both', bottom='off', top='off')
        ax.tick_params(axis='y', which='both', left='off', right='off')

    ylim = dict(grad=(-170, 200))
    evoked.pick_types(meg='grad', exclude=[])
    evoked.plot(exclude=[], axes=axes[0], ylim=ylim, show=False)
    axes[0].set_title('Before autoreject')
    evoked_clean.pick_types(meg='grad', exclude=[])
    evoked_clean.plot(exclude=[], axes=axes[1], ylim=ylim)
    axes[1].set_title('After autoreject')
    plt.tight_layout()




.. image:: /auto_examples/images/sphx_glr_plot_auto_repair_001.png
    :align: center




To top things up, we can also visualize the bad sensors for each trial using
a heatmap.


.. code-block:: python


    set_matplotlib_defaults(plt)

    plt.figure(figsize=(12, 6))
    im = plt.imshow(ar.bad_segments[:, picks], cmap='Reds',
                    interpolation='nearest')

    ch_names = [epochs.ch_names[pp] for pp in picks][7::10]
    ax = im.get_axes()
    ax.grid(False)
    ax.set_xlabel('Sensors')
    ax.set_ylabel('Trials')
    plt.setp(ax, xticks=range(7, len(picks), 10),
             xticklabels=ch_names)
    plt.setp(ax.get_yticklabels(), rotation=0)
    plt.setp(ax.get_xticklabels(), rotation=90)
    ax.tick_params(axis=u'both', which=u'both', length=0)
    plt.tight_layout(rect=[None, None, None, 1.1])
    plt.show()



.. image:: /auto_examples/images/sphx_glr_plot_auto_repair_002.png
    :align: center




**Total running time of the script:**
(3 minutes 14.215 seconds)



.. container:: sphx-glr-download

    **Download Python source code:** :download:`plot_auto_repair.py <plot_auto_repair.py>`


.. container:: sphx-glr-download

    **Download IPython notebook:** :download:`plot_auto_repair.ipynb <plot_auto_repair.ipynb>`
